/*1325568615,169775558*/

if (window.CavalryLogger) { CavalryLogger.start_js(["dQhsu"]); }

__e("CallbackManager",["copyProperties"],function(d,f,e,c){var b=f('copyProperties');var a=function(){this._pending=[];this._resources={};};a.prototype={executeOrEnqueue:function(k,g){var h=g;var j=k;if(!(k instanceof Array)){j=[j];h=function(l){g(l[k]);};}var i=this._attemptCallback(h,j);if(i)return [];this._pending.push({fn:h,resources:j});return this._getUnavailableResources(j);},addResourcesAndExecute:function(g){b(this._resources,g);this._runPossibleCallbacks();},setResource:function(g,h){this._resources[g]=h;this._runPossibleCallbacks();},getResource:function(g){return this._resources[g];},_runPossibleCallbacks:function(){var g=this._pending;this._pending=[];var h=[];g.forEach(function(i){if(this._constructCallbackArg(i.resources,true)){h.push(i);}else this._pending.push(i);}.bind(this));h.forEach(function(i){this._attemptCallback(i.fn,i.resources);}.bind(this));},_attemptCallback:function(h,i){var g=this._constructCallbackArg(i,true);g&&h(g);return !!g;},_constructCallbackArg:function(k,g){var l={};for(var h=0;h<k.length;h++){var i=k[h];var j=this._resources[i];if(typeof j=='undefined'&&g)return false;l[i]=j;}return l;},_getUnavailableResources:function(g){return g.filter(function(h){return !this._resources[h];}.bind(this));}};e.exports=a;});
__e("TimestampConverter",["JSLogger"],function(f,h,g,e){var a=h('JSLogger');var d=a.create('timestamp_converter');function c(i){return (typeof(i)=='string')&&i.length>6;}var b={convertActionIDToTimestamp:function(i){if(c(i)){var j=i.slice(0,-6);return parseInt(j,10);}},maxValidActionID:function(i,k){if(!c(i))return k;if(!c(k))return i;var j=(this.convertActionIDToTimestamp(i)>this.convertActionIDToTimestamp(k))?i:k;return j;}};g.exports=b;});
__e("MercuryAssert",[],function(b,d,c,a){c.exports={allThreadID:function(e){e.forEach(this.isThreadID);},isThreadID:function(e){if(!e||typeof e!=='string'||e.indexOf(':')===-1)throw 'bad_thread_id';}};});
__e("MercuryServerDispatcher",["copyProperties","AsyncRequest","FunctionUtils","uri","Dialog"],function(i,k,j,h){var g=k('copyProperties');var a=k('AsyncRequest');var c=k('FunctionUtils');var e=k('uri');var f={};var d={IMMEDIATE:'immediate',IDEMPOTENT:'idempotent',BATCH_SUCCESSIVE:'batch-successive',BATCH_DEFERRED_MULTI:'batch-deferred-multi',registerEndpoints:function(l){for(var n in l){var m=l[n];f[n]=new b(n,m);}},trySend:function(m,l){f[m].trySend(l);}};function b(n,m){var l=m.mode||d.IMMEDIATE;switch(l){case d.IMMEDIATE:case d.IDEMPOTENT:case d.BATCH_SUCCESSIVE:case d.BATCH_DEFERRED_MULTI:break;default:throw new Error('Invalid MercuryServerDispatcher mode '+l);}this._endpoint=n;this._mode=l;this._combineData=m.batch_function;this._handler=m.handler;this._errorHandler=m.error_handler;this._deferredSend=c.debounce(this._batchSend.bind(this),0,false);}b.prototype={_inFlight:0,_handler:null,_errorHandler:null,_combineData:null,trySend:function(l){if(typeof l=='undefined')l=null;var m=this._mode;if(m==d.IMMEDIATE){this._send(l);}else if(m==d.IDEMPOTENT){if(!this._inFlight)this._send(l);}else if(m==d.BATCH_SUCCESSIVE){if(!this._inFlight){this._send(l);}else this._batchData(l);}else if(m==d.BATCH_DEFERRED_MULTI){this._batchData(l);this._deferredSend();}},_send:function(l){this._inFlight++;new a(this._endpoint).setData(l).setHandler(this._handleResponse.bind(this)).setErrorHandler(this._handleError.bind(this)).setTransportErrorHandler(this._handleError.bind(this)).send();},_batchData:function(l){if(typeof this._batchedData=='undefined'){this._batchedData=l;}else this._batchedData=this._combineData(this._batchedData,l);},_batchSend:function(){if(typeof this._batchedData!='undefined'){this._send(this._batchedData);delete this._batchedData;}},_handleResponse:function(m){this._inFlight--;var l=m.getPayload();if(l&&l.error_payload){if(this._errorHandler)this._errorHandler(m);}else this._handler&&this._handler(l);if(this._mode==d.BATCH_SUCCESSIVE)this._batchSend();},_handleError:function(l){this._errorHandler&&this._errorHandler(l);this._inFlight--;}};j.exports=d;});
__e("MercuryThreadInformer",["arbiter","copyProperties","MercuryAssert"],function(l,n,m,k){var a=n('arbiter');var j=n('copyProperties');var b=n('MercuryAssert');var f={};var g=false;var i=false;var e={};var d=0;function h(){if(!d)try{var changed_threads=keys(f);if(changed_threads.length||g)c.inform('threadlist-updated',changed_threads);if(changed_threads.length)c.inform('threads-updated',f);if(i)c.inform('unseen-updated',null);var received_message_threads=keys(e);if(received_message_threads.length)c.inform('messages-received',e);}catch(o){throw o;}finally{f={};g=false;i=false;e={};}}var c=j(new a(),{updatedThread:function(o){f[o]=true;h();},updatedThreadlist:function(){g=true;h();},updatedUnseenState:function(){i=true;h();},receivedMessage:function(o){b.isThreadID(o.thread_id);var p=o.thread_id;if(!e[p])e[p]=[];e[p].push(o);this.updatedThread(p);},synchronizeInforms:function(o){d++;try{o();}catch(p){throw p;}finally{d--;h();}},listen:function(p,o){return this.subscribe('threads-updated',function(r,q){if(q[p])o(p);});}});m.exports=c;});
__e("MercuryServerRequests",["arbiter","CallbackManager","TimestampConverter","copyProperties","Env","JSLogger","MercuryAssert","ObjectUtils","MercuryServerDispatcher","MercuryThreadInformer","hasArrayNature","MercuryConstants"],function(zc,zf,ze,zb){var a=zf('arbiter');var b=zf('CallbackManager');var d=zf('TimestampConverter');var z=zf('copyProperties');var e=zf('Env');var f=zf('JSLogger');var g=zf('MercuryAssert');var h=zf('ObjectUtils');var i=zf('MercuryServerDispatcher');var k=zf('MercuryThreadInformer');var zd=zf('hasArrayNature');var c=zf('MercuryConstants');var t=0;var s=f.create('mercury_server');var v=new b();var m=new b();var x=[];var o={};function y(zg){t=d.maxValidActionID(t,zg);}function n(zj){var zi=zj.thread_id;var zg=v.getResource(zi);if(!zg){if(zj.is_canonical_user){var zh=zj.participants;if(zh.length==1){zg='user:'+e.user;}else zh.forEach(function(zl){var zk=w(zl);if(zk.type=='fbid'&&zk.value!=e.user)zg='user:'+zk.value;});}else if(zj.is_canonical_group){zg='group:'+zj.group_id;}else if(zj.root_message_threading_id)zg='root:'+zj.root_message_threading_id;zg=zg||'thread:'+zi;v.setResource(zi,zg);m.setResource(zg,zi);}zj.thread_id=zg;}function w(zh){var zg=zh.indexOf(':');if(zg<=0)throw new Error('Not a token',zh);return {type:zh.substr(0,zg),value:zh.substr(zg+1)};}function q(zj,zg){var zi=m.executeOrEnqueue(zj,zg);var zh=j.tokenizeThreadID(zj);if(zi.length&&zh.type!='root')j.fetchThreadData(zi);}function r(zg){return m.getResource(zg);}function p(zh){var zg=v.getResource(zh);if(typeof zg=='undefined')s.warn('no_client_thread_id',{server_id:zh});return zg;}function u(zg){(zg.threads||[]).forEach(function(zh){n(zh);delete o[zh.thread_id];y(zh.last_action_id);});(zg.ordered_threadlists||[]).forEach(function(zh){zh.thread_ids=zh.thread_ids.map(p);});if(x.length){zg.actions=x.concat(zg.actions?zg.actions:[]);x=[];}zg.actions=zg.actions||[];zg.actions.forEach(function(zh){if(zh.action_type==c.MercuryActionType.SEND_MESSAGE&&zh.client_thread_id){m.setResource(zh.client_thread_id,zh.thread_id);v.setResource(zh.thread_id,zh.client_thread_id);}zh.thread_id=p(zh.thread_id);y(zh.action_id);});if(zg.unseen_thread_ids)zg.unseen_thread_ids=zg.unseen_thread_ids.map(p);}function l(zi,zg){var zj=z({},zi);for(var zh in zg)if(zd(zj[zh])){zj[zh]=keys(h.createFrom(zj[zh].concat(zg[zh])));}else if(zj[zh]){zj[zh]=z(zj[zh],zg[zh]);}else zj[zh]=zg[zh];return zj;}var j=z(new a(),{tokenizeThreadID:function(zg){g.isThreadID(zg);return w(zg);},getServerThreadID:function(zh,zg){g.isThreadID(zh);q(zh,zg);},fetchMissedMessages:function(){i.trySend('/mercury/ajax/thread_sync.php',{last_action_id:t});},fetchThreadData:function(zj){g.allThreadID(zj);var zh={};var zl=[];var zk=[];var zi=[];zj.forEach(function(zn){if(o[zn])return;o[zn]=true;var zm=j.tokenizeThreadID(zn);if(zm.type=='user'){zl.push(zm.value);zh.users=zl;}else if(zm.type=='group'){zi.push(zm.value);zh.groups=zi;}else if(zm.type=='thread'){zk.push(zm.value);zh.threads=zk;}else throw new Error('Unknown thread type',zm);});for(var zg in zh){i.trySend('/mercury/ajax/thread_info.php',zh);break;}},fetchThreadMessages:function(zh,zg){g.isThreadID(zh);q(zh,function(zj){var zi={messages:{}};zi.messages[zj]=zg;i.trySend('/mercury/ajax/thread_info.php',zi);});},handleThreadInfoError:function(zj){var zh=zj.getRequest().getData();var zg=[];if(zh.messages){var zi=zh.messages;for(var zk in zi)zg.push({action_type:c.MercuryActionType.LOG_MESSAGE,thread_id:zk,message_id:zk,timestamp:1,timestamp_absolute:'',timestamp_relative:'',is_unread:false,source:c.MercurySourceType.UNKNOWN,log_message_type:c.MercuryLogMessageType.SERVER_ERROR,log_message_data:{}});}if(zg.length)j.handleUpdate({actions:zg});if((zh.users||zh.groups||zh.threads)&&!zh.is_retry){if(zh.messages)delete zh.messages;zh.is_retry=true;i.trySend('/mercury/ajax/thread_info.php',zh);}},changeThreadReadStatus:function(zh,zg){g.isThreadID(zh);q(zh,function(zj){var zi={ids:{}};zi.ids[zj]=zg;i.trySend('/mercury/ajax/change_read_status.php',zi);});},_batchThreadRead:function(zi,zh){var zg={};z(zg,zi.ids);z(zg,zh.ids);return {ids:zg};},sendNewMessage:function(zh){var zg=j.tokenizeThreadID(zh.thread_id);var zi=z({},zh);if((zg.type=='root'&&zg.value==zi.message_id)||(zg.type=='user'&&!r(zh.thread_id))){zi.thread_id=null;this._sendNewMessageToServer(zi);}else q(zi.thread_id,function(zk){zi.thread_id=zk;j._sendNewMessageToServer(zi);});var zj={actions:[z({},zh)]};j.handleUpdate(zj,true);},_sendNewMessageToServer:function(zg){i.trySend('/mercury/ajax/send_messages.php',{message_batch:[zg]});},_batchMessageSend:function(zh,zg){return {message_batch:zh.message_batch.concat(zg.message_batch)};},requestMessageConfirmation:function(zh){var zg={};for(var zj in zh){var zi=r(zj);if(zi)zg[zi]=zh[zj];}var zk=h.getKeys(zg);if(zk.length)i.trySend('/mercury/ajax/confirm_messages.php',{thread_message_map:zg});},handleMessageConfirmError:function(zi){var zk=zi.getRequest().getData().thread_message_map;if(!zk)return;var zg=[];for(var zj in zk){var zh=zk[zj];zh.forEach(function(zl){zg.push({action_type:c.MercuryActionType.SEND_MESSAGE,client_message_id:zl,message_id:zl,client_thread_id:null,thread_id:zj,status:c.MercuryActionStatus.UNABLE_TO_CONFIRM});});}if(zg.length)this.handleUpdate({actions:zg});},markSeen:function(){var zg=d.convertActionIDToTimestamp(t);i.trySend('/mercury/ajax/mark_seen.php',{seen_timestamp:zg});},_batchMarkSeen:function(zh,zg){return zg;},handleUpdate:function(zi,zh){for(var zg in zi){k.synchronizeInforms(function(){if(!zh)u(zi);this.inform('update-participants',zi);this.inform('update-threads',zi);this.inform('update-threadlist',zi);this.inform('update-messages',zi);this.inform('update-unseen',zi);this.inform('model-update-completed',null);}.bind(this));break;}},handleSendMessageError:function(zk){var zi=zk.getPayload();var zj=zk.getRequest().getData();var zg=zj.message_batch;if(!zg)return;var zm;if(zi&&zi.error_payload){zm=c.MercuryActionStatus.UNCONFIRMED;}else zm=c.MercuryActionStatus.REQUEST_ERROR;var zl=zg.map(function(zn){return {action_type:c.MercuryActionType.SEND_MESSAGE,client_message_id:zn.message_id,message_id:zn.message_id,client_thread_id:null,thread_id:zn.thread_id,status:zm};});var zh={actions:zl};this.handleUpdate(zh);},getLastActionID:function(){return t;},receivedMessage:function(zg){var zi=v.getResource(zg.thread_id);if(zi){j.handleUpdate({actions:[z({},zg)]});return;}var zh=v.executeOrEnqueue(zg.thread_id,function(zj){x.push(z({},zg));});i.trySend('/mercury/ajax/thread_info.php',{threads:zh});}});var za=j.handleUpdate.bind(j);i.registerEndpoints({'/mercury/ajax/thread_sync.php':{mode:i.IDEMPOTENT,handler:za},'/mercury/ajax/thread_info.php':{mode:i.BATCH_DEFERRED_MULTI,batch_function:l,handler:za,error_handler:j.handleThreadInfoError.bind(j)},'/mercury/ajax/change_read_status.php':{mode:i.BATCH_SUCCESSIVE,batch_function:j._batchThreadRead,handler:za},'/mercury/ajax/send_messages.php':{mode:i.BATCH_SUCCESSIVE,batch_function:j._batchMessageSend,handler:za,error_handler:j.handleSendMessageError.bind(j)},'/mercury/ajax/mark_seen.php':{mode:i.BATCH_SUCCESSIVE,batch_function:j._batchMarkSeen,handler:za},'/mercury/ajax/confirm_messages.php':{mode:i.IMMEDIATE,handler:za,error_handler:j.handleMessageConfirmError.bind(j)}});ze.exports=j;});
__e("MercuryThreads",["copyProperties","JSLogger","CallbackManager","TimestampConverter","MercuryAssert","MercuryServerRequests","MercuryThreadInformer","MercuryConstants","Env"],function(s,u,t,r){var q=u('copyProperties');var d=u('JSLogger');var a=u('CallbackManager');var c=u('TimestampConverter');var e=u('MercuryAssert');var f=u('MercuryServerRequests');var g=u('MercuryThreadInformer');var b=u('MercuryConstants');var m=d.create('mercury_threads');var o=new a();function i(zb,z,w){var y=c.maxValidActionID(zb.action_id,w);if(!w||y===w){var v=u('Env');var za=Object.from(zb.participants,true);var x='fbid:'+v.user;z.forEach(function(zc){if(za[zc]!==true){zb.participants.push(zc);if(zc===x)zb.is_subscribed=true;}});}}function n(z,y,w){var x=c.maxValidActionID(z.action_id,w);if(!w||x===w){var v=u('Env');z.participants.remove(y);if(y==='fbid:'+v.user)z.is_subscribed=false;}}function j(w,v){if(w.participants[0]!=v){w.participants.remove(v);w.participants.unshift(v);}}function k(x,w){var v=!x.unread_count;if(!x||w==v)return false;x.unread_count=w?0:1;return true;}function p(x,v){var y=v.action_type;if(y==b.MercuryActionType.USER_GENERATED_MESSAGE||y==b.MercuryActionType.LOG_MESSAGE){v.is_unread&&x.unread_count++;x.is_archived=false;}switch(y){case b.MercuryActionType.USER_GENERATED_MESSAGE:j(x,v.author);break;case b.MercuryActionType.LOG_MESSAGE:var w=v.log_message_type;if(w==b.MercuryLogMessageType.SUBSCRIBE){i(x,v.log_message_data.added_participants,v.action_id);}else if(w==b.MercuryLogMessageType.UNSUBSCRIBE)n(x,v.author,v.action_id);break;case b.MercuryActionType.CHANGE_READ_STATUS:k(x,v.mark_as_read);break;}x.last_action_id=c.maxValidActionID(v.action_id,x.last_action_id);}function l(w){var v=f.tokenizeThreadID(w.thread_id);if(v.type=='group'){m.error('invalid_new_thread_message',w);return undefined;}var x={thread_id:w.thread_id,last_action_id:w.action_id,participants:w.specific_to_list,name:null,snippet:w.body,snippet_has_attachment:false,unread_count:0,image_src:null,timestamp_absolute:w.timestamp_absolute,timestamp_relative:w.timestamp_relative,timestamp:w.timestamp,is_canonical_user:v.type=='user',is_subscribed:true,is_canonical_group:false,group_id:null,root_message_threading_id:w.message_id,folder:b.MessagingTag.INBOX,is_archived:false};o.setResource(x.thread_id,x);return x;}var h={getThreadMetaNow:function(v){e.isThreadID(v);return o.getResource(v);},getThreadMeta:function(y,v){e.isThreadID(y);var w=o.executeOrEnqueue(y,v);if(!w.length)return;var x=f.tokenizeThreadID(y);if(x.type=='user'){this.getCanonicalThreadToUser(x.value);}else f.fetchThreadData(w);},changeThreadReadStatus:function(x,v){e.isThreadID(x);var w=o.getResource(x);if(k(w,v)){f.changeThreadReadStatus(x,v);g.updatedThread(x);}},updateThreads:function(w){if(!w||!w.length)return;var v={};w.forEach(function(x){v[x.thread_id]=x;});o.addResourcesAndExecute(v);},updateMetadataByActions:function(w){if(!w||!w.length)return;var ze={};var zd={};var zf={};for(var y=0;y<w.length;y++){var v=w[y];var zh=v.action_type;var zg=v.thread_id;e.isThreadID(zg);var zc=this.getThreadMetaNow(zg);if(zh==b.MercuryActionType.LOG_MESSAGE&&v.log_message_type==b.MercuryLogMessageType.SERVER_ERROR)continue;if(!zc&&!v.action_id&&zh==b.MercuryActionType.USER_GENERATED_MESSAGE)zc=l(v);if(zc){if(!zf[zg])zf[zg]=q({},zc);if(v.timestamp<=zc.timestamp&&v.action_id)continue;p(zf[zg],v);if(zh==b.MercuryActionType.USER_GENERATED_MESSAGE){ze[zg]=v;zd[zg]=v;}else if(zh==b.MercuryActionType.LOG_MESSAGE)zd[zg]=v;}}for(var zb in zf){var x=zf[zb];var za=ze[zb];if(za){x.snippet=za.body;x.is_forwarded_snippet=za.is_forwarded;}var z=zd[zb];if(z)x=q(x,{timestamp_absolute:z.timestamp_absolute,timestamp_relative:z.timestamp_relative,timestamp:z.timestamp});o.setResource(zb,x);}},getCanonicalThreadToGroup:function(w,v){var x='group:'+w;this.getThreadMeta(x,v);},getCanonicalThreadToUser:function(z){var y='user:'+z;var x=o.getResource(y);if(typeof x=='undefined'){var v=u('Env');x={thread_id:y,last_action_id:null,participants:['fbid:'+v.user,'fbid:'+z],name:null,snippet:'',snippet_has_attachment:false,unread_count:0,image_src:null,timestamp_absolute:null,timestamp_relative:null,timestamp:null,is_canonical_user:true,is_subscribed:true,is_canonical_group:false,group_id:null,root_message_threading_id:null,folder:b.MessagingTag.INBOX,is_archived:false};var w={};w[y]=x;o.addResourcesAndExecute(w);f.fetchThreadData([y]);}return x;},getCanonicalUserInThread:function(w){var v=f.tokenizeThreadID(w);return v.type=='user'?v.value:null;}};f.subscribe('update-threads',function(v,w){h.updateMetadataByActions(w.actions);h.updateThreads(w.threads);(w.threads||[]).each(function(x){g.updatedThread(x.thread_id);});});t.exports=h;});
__e("ChatActivity",["arbiter","copyProperties","event-extensions","MercuryThreads","UserActivity"],function(k,m,l,j){var b=m('arbiter');var i=m('copyProperties');m('event-extensions');var d=m('MercuryThreads');var e=m('UserActivity');var a=60000;var h=true;function f(){return !!(h&&e.isActive(a));}var c=i(new b(),{isActive:f});function g(){c.inform('activity');}Event.listen(window,'focus',function(){h=true;g();});Event.listen(window,'blur',function(){h=false;});e.subscribe(function(){if(h)g();});l.exports=c;});
__e("ChatTabModel",["ArrayUtils","JSLogger","math-extensions","MercuryAssert","PresenceState","ObjectUtils","copyProperties","arbiter"],function(za,zc,zb,z){var b=zc('ArrayUtils');var c=zc('JSLogger');var d=zc('math-extensions');var e=zc('MercuryAssert');var g=zc('PresenceState');var f=zc('ObjectUtils');var y=zc('copyProperties');var w=[];var t=null;var m=0;var p=20;var l=c.create('chat_tab_model');var u=false;function v(zd){zd.t2=[];zd.uct2=m;zd.lm2=t;w.forEach(function(zf){if(!zf.fragile){var ze={i:zf.id};if(zf.raised)ze.r=1;zd.t2.push(ze);}});return zd;}function n(ze){if(ze&&ze.t2){var zf=d.verifyNumber(ze.uct2);if(zf>m){m=zf;l.log('load_cookie_tabs',{tabs:ze.t2,promoted:ze.lm2});var zd=ze.t2;o(zd,ze.lm2||null);}}}function o(ze,zd){if(x(ze,zd)){w=ze.map(function(zg){var zf={id:zg.i};if(zg.r)zf.raised=true;if(zf.id==zd)t=zf.id;return zf;});j();q();}}function x(zg,zf){if(zf!=t)return true;if(zg.length!=w.length)return true;for(var zd=0,ze=zg.length;zd<ze;zd++)if(!f.areEqual(zg[zd],w[zd]))return true;return false;}function q(){if(u)ChatTabModel.inform('chat/tabs-changed',ChatTabModel.get());}function i(){m=Math.floor(Date.now()*.001);g.doSync();q();}function j(){var zd=w.length-p;if(zd>0)w=w.filter(function(ze){return ze.raised||zd--<=0;});}function k(ze){for(var zd=0;zd<w.length;zd++)if(w[zd].id==ze)return zd;return -1;}function r(zd){if(k(zd)===-1){w.push({id:zd,fragile:true});return true;}return false;}function s(ze){var zf=k(ze);if(zf!=-1)if(w[zf].fragile){w.splice(zf,1);}else return false;for(var zd=0;zd<=w.length;zd++)if(zd==w.length||w[zd].fragile){w.splice(zd,0,{id:ze});j();return true;}}function h(zd){var ze=k(zd);if(ze!=-1){w.splice(ze,1);return true;}return false;}g.registerStateStorer(v);g.registerStateLoader(n);var a=zc('arbiter');zb.exports=ChatTabModel=y(new a(),{indexOf:function(zd){return k(zd);},closeAllTabs:function(){if(w.length){w=[];t=null;i();}},closeFragileTabs:function(){for(var zd=0;zd<w.length;zd++)if(w[zd].fragile){w.splice(zd);q();break;}},closeTab:function(zd){e.isThreadID(zd);if(h(zd)){if(t==zd)t=null;i();}},raiseTab:function(ze){e.isThreadID(ze);var zd=s(ze);var zf=k(ze);if(!w[zf].raised){w[zf].raised=true;i();}},get:function(){var zd=w.map(function(ze){var zf=y({},ze);delete zf.fragile;return zf;});return {tabs:zd,promoted:t};},openFragileTab:function(zd){e.isThreadID(zd);if(r(zd))q();},openTab:function(zd){e.isThreadID(zd);if(s(zd))i();},lowerTab:function(zd){e.isThreadID(zd);var ze=k(zd);if(ze!=-1&&w[ze].raised){delete w[ze].raised;i();}},raiseAndPromoteTab:function(zd){e.isThreadID(zd);s(zd);var ze=k(zd);if(!w[ze].raised||t!=zd){w[ze].raised=true;t=zd;i();}}});n(g.get(),true);u=true;});
__e("ChatController",["ChatTabModel","MercuryThreads"],function(d,f,e,c){var a=f('ChatTabModel');var b=f('MercuryThreads');e.exports={raiseFragileGroupTab:function(g){b.getCanonicalThreadToGroup(g,function(h){a.openFragileTab(h.thread_id);});},raiseGroupTab:function(g){b.getCanonicalThreadToGroup(g,function(h){a.raiseTab(h.thread_id);});}};});
__e("MercuryRequireEnsure",[],function(b,d,c,a){c.exports.ensure=function(f,g,e){d.ensure(f,g,e);};});
__e("MercuryParticipants",["Env","JSLogger","ObjectUtils","ShortProfiles","MercuryServerRequests","copyProperties"],function(n,p,o,m){var a=p('Env');var b=p('JSLogger');var c=p('ObjectUtils');var f=p('ShortProfiles');var e=p('MercuryServerRequests');var l=p('copyProperties');var k='fbid:'+a.user;var j={};var i=b.create('mercury_participants');var g=function(q){if(!j[q.id])j[q.id]=l({},q);};function h(r){var q=r.indexOf(':');var s=r.substr(0,q);if(s!='fbid')return null;return r.substr(q+1);}var d={user:k,get:function(r,q){this.getMulti([r],function(s){q(s[r]);});},getMulti:function(r,q){var u={};var s={};var v=[];r.forEach(function(w){if(j[w]){u[w]=l({},j[w]);}else{var x=h(w);if(x){s[w]=x;}else v.push(w);}});if(v.length){i.warn('unresolved',{ids:v});return;}var t=c.getValues(s);if(t.length){f.getMulti(t,function(z){for(var w in s){var y=s[w];var x=z[y];u[w]={gender:x.gender,href:x.uri,id:w,image_src:x.thumbSrc,name:x.name,short_name:x.firstName};}q(u);});}else q(u);},addParticipants:function(q){q.forEach(g);}};e.subscribe('update-participants',function(r,q){d.addParticipants(q.participants||[]);});o.exports=d;});
__e("ChatSound",["MercuryParticipants","MercuryThreads"],function(e,g,f,d){var a=g('MercuryParticipants');var b=g('MercuryThreads');window.Sound&&window.Sound.init(['audio/ogg','audio/mpeg']);function c(){window.Sound&&window.Sound.play(['/sound/pling.ogg','/sound/pling.mp3'],true,false);}f.exports={messageReceived:function(h){if(window.chatOptions&&window.chatOptions.getSetting('sound'))if(h.sender!=a.user)b.getThreadMeta(h.thread_id,function(i){if(i.is_canonical_user)c();});},play:function(){if(window.chatOptions&&window.chatOptions.getSetting('sound'))c();}};});
__e("MercuryClientTimestamp",[],function(d,f,e,c){var b=0;var a={setServerStartTime:function(g){b=g-(new Date()).getTime();},getTimestamp:function(){return (new Date()).getTime()+b;}};e.exports=a;});
__e("MercuryMessages",["copyProperties","Env","math-extensions","ObjectUtils","tx","MercuryClientTimestamp","CallbackManager","MercuryConstants","PresenceUtil","MercuryServerRequests","MercuryThreadInformer","MercuryThreads"],function(w,y,x,v){var u=y('copyProperties');var d=y('Env');var e=y('math-extensions');var g=y('ObjectUtils');w.tx=y('tx');var b=y('MercuryClientTimestamp');var a=y('CallbackManager');var c=y('MercuryConstants');var h=y('PresenceUtil');var i=y('MercuryServerRequests');var j=y('MercuryThreadInformer');var k=y('MercuryThreads');var c=y('MercuryConstants');var q={};var p={};var m={};var s=function(z){var za=z;if(p[z])za=p[z];return q[za];};var t=new a();function o(z){return t.getResource(z);}var n=function(za){var z=za+':'+(e.rand32()+1)+'-'+h.getSessionID();return '<'+z+'@mail.projektitan.com>';};function r(za){za.message_id=n(za.timestamp);var zd='fbid:'+d.user;za.specific_to_list=za.specific_to_list||[];if(za.specific_to_list.length&&za.specific_to_list.indexOf(zd)===-1)za.specific_to_list.push(zd);if(!za.thread_id){if(za.specific_to_list.length==1){za.thread_id='user:'+d.user;}else if(za.specific_to_list.length==2){var zb=za.specific_to_list[0]==zd?za.specific_to_list[1]:za.specific_to_list[0];var z=zb.indexOf(':');if(zb.substr(0,z)=='fbid')za.thread_id='user:'+zb.substr(z+1);}za.thread_id=za.thread_id||'root:'+za.message_id;}if(!za.specific_to_list.length){var zc=i.tokenizeThreadID(za.thread_id);if(zc.type=='user')za.specific_to_list=['fbid:'+zc.value,'fbid:'+d.user];}}function l(z,zb,zc){var zd=b.getTimestamp();var za={action_type:z,thread_id:zc,author:'fbid:'+d.user,timestamp:zd,timestamp_absolute:(new Date(zd)).toLocaleString(),timestamp_relative:"a few seconds ago",is_unread:false,source:zb};return za;}var f={getThreadMessageIDs:function(zd,za,z){var zc=t.executeOrEnqueue(zd,z);var zb=m[zd];if((zc.length||t.getResource(zd).length<za)&&!zb){i.fetchThreadMessages(zd,za);}else m[zd]=false;},getThreadMessages:function(zb,za,z){this.getThreadMessageIDs(zb,za,function(zc){var zd=zc.map(s);z(zd);});},handleMessageUpdates:function(ze){var zh={};var zf={};for(var zb=0;zb<ze.length;zb++){var zc=ze[zb];var z=zc.action_type;if(z==c.MercuryActionType.SEND_MESSAGE){var za=zc.client_message_id;if(za&&p[za]&&zc.status){if(zc.status==c.MercuryActionStatus.UNCONFIRMED){if(!zf[zc.thread_id])zf[zc.thread_id]=[];zf[zc.thread_id].push(zc.client_message_id);}else if(!zh[zc.thread_id])zh[zc.thread_id]=[];s(zc.client_message_id).status=zc.status;}continue;}else if(z==c.MercuryActionType.LOG_MESSAGE)if(zc.log_message_type==c.MercuryLogMessageType.SERVER_ERROR)m[zc.thread_id]=true;if((zc.threading_id&&p[zc.threading_id])||q[zc.message_id])continue;if(!zh[zc.thread_id])zh[zc.thread_id]=[];zh[zc.thread_id].push(zc.message_id);q[zc.message_id]=zc;j.receivedMessage(zc);}for(var zg in zh){var zd=t.getResource(zg);if(!zd)zd=[];zd=zd.filter(function(zj){var zk=q[zj];return zk.action_type!=c.MercuryActionType.LOG_MESSAGE||zk.log_message_type!=c.MercuryLogMessageType.SERVER_ERROR;});if(zh[zg].length){zd=zd.concat(zh[zg]);zd.sort(function(zl,zm){var zj=q[zl];var zk=q[zm];return (zj.timestamp-zk.timestamp);});}t.setResource(zg,zd);j.updatedThread(zg);}var zi=g.getKeys(zf);if(zi.length)i.requestMessageConfirmation(zf);},sendMessage:function(z){r(z);p[z.message_id]=z.message_id;j.synchronizeInforms(function(){this.handleMessageUpdates([z]);i.sendNewMessage(z);}.bind(this));},resendMessage:function(z){var za=u({},z);za.status=c.MercuryActionStatus.UNSENT;za.timestamp=b.getTimestamp();s(z.message_id).status=c.MercuryActionStatus.RESENT;this.sendMessage(za);},updateLocalMessage:function(z,za){p[z]=za;q[za]=q[z];q[z]={};},constructUserGeneratedMessageObject:function(z,zb,zd,zc){var za=l(c.MercuryActionType.USER_GENERATED_MESSAGE,zb,zd);za.body=z;za.specific_to_list=zc||[];return za;},constructLogMessageObject:function(zc,zd,za,z){var zb=l(c.MercuryActionType.LOG_MESSAGE,zc,zd);zb.log_message_type=za;zb.log_message_data=z;return zb;}};i.subscribe('update-messages',function(za,z){if(!z.actions||!z.actions.length)return;var zb=z.actions.filter(function(zc){var zd=zc.action_type;return (zd==c.MercuryActionType.LOG_MESSAGE||zd==c.MercuryActionType.USER_GENERATED_MESSAGE||zd==c.MercuryActionType.SEND_MESSAGE);});f.handleMessageUpdates(zb);});x.exports=f;});
__e("MercuryNotificationRenderer",["MercuryAssert","MercuryMessages","MercuryParticipants","MercuryThreads","tx"],function(f,i,g,e){var a=i('MercuryAssert');var b=i('MercuryMessages');var c=i('MercuryParticipants');var d=i('MercuryThreads');f.tx=i('tx');function h(k,j){a.isThreadID(k);d.getThreadMeta(k,function(l){b.getThreadMessages(k,1,function(n){var m=n.length&&n[n.length-1];if(m&&m.author!=c.user){c.get(m.author,function(o){if(l.name){j(_tx("{senderName} messaged {groupName}",{senderName:o.short_name,groupName:l.name}));}else j(_tx("{name} messaged you",{name:o.short_name}));});}else j("New message!");});});}g.exports={renderDocumentTitle:h};});
__e("MercuryUnseenState",["copyProperties","TimestampConverter","ObjectUtils","MercuryServerRequests","MercuryThreadInformer","tx"],function(o,q,p,n){var m=q('copyProperties');var a=q('TimestampConverter');var c=q('ObjectUtils');var d=q('MercuryServerRequests');var e=q('MercuryThreadInformer');o.tx=q('tx');var h=0;var j=[];var k=c.createFrom(j,true);var i=false;var b=99;function l(t){if(t.message_counts&&t.message_counts.seen_timestamp){if(t.message_counts.unseen_count>b){i=true;}else{var w=t.message_counts.seen_timestamp;var x=t.unseen_thread_ids||[];f.updateState(w,x);}}else{if(i)return;var s=t.actions;if(!s||!(s.length))return;var v={};for(var u=0;u<s.length;u++){var r=s[u];if(r.is_unread&&(!v[r.thread_id]||r.action_id>v[r.thread_id]))v[r.thread_id]=r.action_id;}f.addUnseenThreads(v);}}function g(r){return a.convertActionIDToTimestamp(r)>h;}var f={getUnseenCount:function(){if(i||(j.length>b)){return _tx("{count}+",{count:b});}else return j.length.toString();},updateState:function(u,v){if((u>h)||i){h=u;v=v||[];if(v.length<=b)i=false;var s={};for(var t in k)if(k[t]!==true){var r=k[t];if(g(r))s[t]=r;}k=m(c.createFrom(v,true),s);j=c.getKeys(k);e.updatedUnseenState();}},addUnseenThreads:function(t){if(i)return;for(var s in t){var r=t[s];if(!k[s]&&g(r)){j.push(s);k[s]=r;e.updatedUnseenState();}}},markAsSeen:function(){if(j.length>0||i){d.markSeen();this.updateState(a.convertActionIDToTimestamp(d.getLastActionID()),[]);}},markThreadSeen:function(r){if(k[r]){delete k[r];j=c.getKeys(k);e.updatedUnseenState();}}};d.subscribe('update-unseen',function(s,r){l(r);});p.exports=f;});
__e("ChatTitleBarBlinker",["ChatActivity","DocumentTitle","MercuryThreadInformer","MercuryNotificationRenderer","PresenceState","MercuryUnseenState","UserActivity"],function(m,o,n,l){var b=o('ChatActivity');var c=o('DocumentTitle');var d=o('MercuryThreadInformer');var e=o('MercuryNotificationRenderer');var f=o('PresenceState');var g=o('MercuryUnseenState');var h=o('UserActivity');var k=null;var j=0;function i(p){if(k){k.stop();k=null;j=p||Date.now();f.doSync();}}var a={blink:function(p){if(!k)e.renderDocumentTitle(p,function(q){if(!k)k=c.blink(q);});},stopBlinking:function(){i();}};f.registerStateStorer(function(p){p.sb2=j;return p;});f.registerStateLoader(function(p){if(p.sb2>j)i(p.sb2);});d.subscribe('unseen-updated',function(){if(g.getUnseenCount()=='0')i();});b.subscribe('activity',function(){i();});n.exports=a;});
__e("ChatTabPolicy",["arbiter","ChatActivity","ChatSound","ChatTabModel","ChatTitleBarBlinker","JSLogger","MercuryAssert","MercuryParticipants","MercuryThreadInformer","MercuryThreads","MercuryUnseenState","ObjectUtils","PresencePrivacy"],function(w,y,x,v){var a=y('arbiter');var b=y('ChatActivity');var c=y('ChatSound');var d=y('ChatTabModel');var e=y('ChatTitleBarBlinker');var f=y('JSLogger');var g=y('MercuryAssert');var h=y('MercuryParticipants');var i=y('MercuryThreadInformer');var j=y('MercuryThreads');var k=y('MercuryUnseenState');var l=y('ObjectUtils');var m=y('PresencePrivacy');var q=f.create('tab_policy');var u={};var n={BLOCKED:{SQUELCH:d.lowerTab,UNBLOCK:p.curry('START')},SQUELCHED:{BLOCK:p.curry('BLOCKED'),ENTER:d.lowerTab,NAVIGATE:p.curry('START')},NORMAL:{BLOCK:p.curry('BLOCKED'),MESSAGE:s,SQUELCH:p.curry('SQUELCHED')},START:{ENTER:function(za){var z='NORMAL';var zb=j.getCanonicalUserInThread(za);if(zb&&!m.allows(zb))z='BLOCKED';p(z,za);}}};function p(z,za){g.isThreadID(za);if(u[za]!=z){q.debug('enter_state',{id:za,state:z});u[za]=z;t('ENTER',za);}}function o(z){if(!u[z])p('START',z);}function t(event,zc,z){o(zc);var zb=u[zc];var za=n[zb][event];za&&za(zc,z);}function r(z){j.changeThreadReadStatus(z,true);k.markThreadSeen(z);}function s(zd,zb){var z=d.indexOf(zd);var za=false;if(z==-1){d.raiseAndPromoteTab(zd);za=true;}else{var zc=d.get();za=zc.tabs[z].raised;}if(b.isActive()){if(za)r(zd);}else{e.blink(zd);zb&&c.messageReceived(zb);}}m.subscribe(['initialized','privacy-changed'],function(){for(var z in u){var za=j.getCanonicalUserInThread(z);if(za)if(m.allows(za)){t('UNBLOCK',z);}else t('BLOCK',z);}});a.subscribe('page_transition',function(){for(var z in u)t('NAVIGATE',z);});(function(){var z=d.get().tabs;z.forEach(function(za){o(za.id);});})();x.exports={getDebugInfo:function(z){g.isThreadID(z);return {id:z,state:u[z]};},messageReceived:function(za,z){g.isThreadID(za,z);t('MESSAGE',za,z);},squelch:function(z){g.isThreadID(z);t('SQUELCH',z);}};},3);